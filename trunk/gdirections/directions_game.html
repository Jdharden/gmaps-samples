<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"  xmlns:v="urn:schemas-microsoft-com:vml">
  <head>
    <title>Google Maps API - Directions Example (directionsSimple.html)</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <script src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key=ABQIAAAAjU0EJWnWPMv7oQ-jjS7dYxSPW5CJgpdgO_s4yyMovOaVh_KvvhSfpvagV18eOyDWu7VytS6Bi1CWxw"
      type="text/javascript"></script>
    <script type="text/javascript"> 

    var map;
    var directions;
    
    var userPoints = [];
    var userLine;
    var lastMarker;

    function onLoad() {
      map = new GMap2(document.getElementById("map"));
      map.setCenter(new GLatLng(37.49975,-122.2629), 15);

      directions = new GDirections(null, null);

      GEvent.addListener(map, "click", mapClick);
    }
  
    function clearGame(){
      userPoints.length = 0;
      lastMarker = null;
      map.clearOverlays();
     }

    function newGame() {
      clearGame();

      var bounds = map.getBounds();
      var southWest = bounds.getSouthWest();
      var northEast = bounds.getNorthEast();
      var lngSpan = northEast.lng() - southWest.lng();
      var latSpan = northEast.lat() - southWest.lat();

      startPoint = new GLatLng(southWest.lat() + latSpan * Math.random(),
                          southWest.lng() + lngSpan * Math.random());
      endPoint = new GLatLng(southWest.lat() + latSpan * Math.random(),
                          southWest.lng() + lngSpan * Math.random());

      GEvent.addListener(directions, "load", function() {
        var route = directions.getRoute(0);

        markerStart = new GMarker(route.getStep(0).getLatLng());
        markerEnd = new GMarker(route.getEndLatLng());
        markerEnd.isEnd = true;        

        map.addOverlay(markerStart);
        map.addOverlay(markerEnd);

        markerStart.setImage("http://www.google.com/intl/en_us/mapfiles/dd-start.png");
        markerEnd.setImage("http://www.google.com/intl/en_us/mapfiles/dd-end.png");
        
        userPoints.push(markerStart.getPoint());
      });

      directions.loadFromWaypoints([startPoint.toUrlValue(), endPoint.toUrlValue()], {getPolyline: true, getSteps: true});
    }

    function loadDirections() {
      var dirPoints = [];
      var dirPoly = directions.getPolyline();
      for (var i = (dirPoly.getVertexCount()-1); i >= 0; i--) {
        var dirPoint = dirPoly.getVertex(i);
        dirPoints.push(dirPoint);
      }

      var allPoints = userPoints.concat(dirPoints);
      var dirLine = new GPolyline(dirPoints, "#00ff00");
      var allPolyShape = new GPolygon(allPoints, "#ff0000", 2, .2, "#ff0000", .2);

      map.addOverlay(dirLine);
      map.addOverlay(allPolyShape);

      var bounds = map.getBounds();
      var southWest = bounds.getSouthWest();
      var northEast = bounds.getNorthEast();
      var northWest = new GLatLng(southWest.lat(), northEast.lng());
      var southEast = new GLatLng(northEast.lat(), southWest.lng());
      var poly = new GPolygon([southWest, southEast, northEast, northWest, southWest]);
      var totalArea = poly.getArea();

      var areaScore = 100 - (allPolyShape.getArea()/totalArea)*200;
      var lengthScore = 100 - (Math.abs(dirLine.getLength() - userLine.getLength())/dirLine.getLength())*50; 
      document.getElementById("areaScore").innerHTML = areaScore.toFixed(2);
      document.getElementById("lengthScore").innerHTML = lengthScore.toFixed(2);
    }
      
    function mapClick(marker, clickedPoint) {
      if (clickedPoint) {
        userPoints.push(clickedPoint);
        updateUserLine();
       } else if (marker.isEnd) {
        userPoints.push(marker.getPoint());
        updateUserLine();
        map.removeOverlay(lastMarker);
        loadDirections();
       }
     }

    function updateUserLine() {
      map.removeOverlay(userLine);
      userLine = new GPolyline(userPoints);
      map.addOverlay(userLine);

      if (!lastMarker) {
        lastMarker = new GMarker(userPoints[userPoints.length - 1]);
        map.addOverlay(lastMarker);
      } 
      lastMarker.setPoint(userPoints[userPoints.length - 1]);
    }
</script>

</head>

  <body onload="onLoad()">
    <input type="button" onclick="newGame()" value="New Game"/>
    &nbsp;
    <b>Area Score:</b> <span id="areaScore"></span>
    <b>Length Score:</b> <span id="lengthScore"></span>
    <br/>
    <div id="map" style="width: 550px; height: 480px; border: 1px solid black;"></div>
    <br/>
    <a href="#" onclick="loadDirections()">load directions</a>
  </body>
</html>
